{% extends "main.html" %}

{% block title %}Fleet Management | BusNaama{% endblock title %}

{% block main %}
<div class="h-full w-full flex flex-col items-center pt-8 pb-12 px-4 md:px-8">
  <div class="w-full max-w-6xl space-y-6">

    <div class="flex flex-col md:flex-row md:items-end justify-between gap-4 border-b border-base-200 pb-5">
      <div>
        <h1 class="text-4xl font-extrabold text-base-content tracking-tight">Fleet Management</h1>
        <p class="text-sm text-base-content/60 mt-1">
          Manage capacity, assignments, and roster for all vehicles.
        </p>
      </div>

      <div class="flex items-center gap-3 w-full md:w-auto">
        <div class="relative flex-grow md:flex-grow-0 group">
          <form method="GET" action="" class="relative flex-grow md:flex-grow-0 group">
            <svg
              class="w-4 h-4 absolute left-3 top-1/2 -translate-y-1/2 text-base-content/40 group-focus-within:text-primary transition-colors"
              fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
            </svg>
            <input type="text" name="search" value="{{ search }}" placeholder="Search by name or ID..."
              class="input input-sm input-bordered w-full md:w-64 pl-9 bg-base-100 focus:border-primary focus:ring-1 focus:ring-primary/30 transition-all shadow-sm" />
          </form>
        </div>

        <a href="{% url 'add_bus' %}"
          class="btn btn-primary btn-sm shadow-sm hover:shadow-md hover:-translate-y-0.5 transition-all">
          <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
          </svg>
          Add Bus
        </a>
      </div>
    </div>

    <div class="bg-base-100 shadow-sm border border-base-200 rounded-2xl overflow-hidden">

      <div id="bulk-actions"
        class="hidden bg-base-200/50 px-6 py-3 border-b border-base-200 flex items-center justify-between transition-all">
        <span id="selectedCount" class="text-sm font-semibold text-base-content">0 selected</span>
        <button class="btn btn-error btn-sm shadow-sm hover:shadow-md hover:-translate-y-0.5 transition-all"
          form="delete-bus">
          <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16">
            </path>
          </svg>
          Delete Selected
        </button>
      </div>

      <form id="delete-bus" action="{% url 'delete_bus' %}" method="post">
        {% csrf_token %}
        <div class="overflow-x-auto">
          <table class="table w-full">
            <thead class="bg-base-200/40 text-base-content/70 text-xs uppercase tracking-wider">
              <tr>
                <th class="w-12 text-center py-4">
                  <input type="checkbox" class="checkbox checkbox-sm rounded" id="selectAll" />
                </th>
                <th class="py-4">Bus Details</th>
                <th class="text-center py-4">Capacity</th>
                <th class="py-4">Assigned Route</th>
                <th class="text-center py-4">Status</th>
                <th class="text-right py-4 pr-6">Actions</th>
              </tr>
            </thead>

            <tbody class="text-base-content text-sm">
              {% for bus in page_obj %}
              <tr class="hover:bg-base-200/30 transition-colors border-b border-base-200/50 last:border-0 group">
                <td class="text-center py-4">
                  <input type="checkbox" name="checkbox-delete" value="{{ bus.id }}"
                    class="checkbox checkbox-sm rounded rowCheck" />
                </td>

                <td class="py-4">
                  <div class="flex flex-col">
                    <span class="font-bold text-base-content">{{ bus.name }}</span>
                    <span class="font-mono text-xs text-base-content/50 mt-0.5">ID: #{{ bus.id }}</span>
                  </div>
                </td>

                <td class="text-center py-4">
                  <div
                    class="inline-flex items-center justify-center bg-base-200 text-base-content px-2.5 py-1 rounded-md text-xs font-semibold border border-base-300">
                    <svg class="w-3.5 h-3.5 mr-1 text-base-content/60" fill="none" stroke="currentColor"
                      viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M17 20h5v-2a4 4 0 00-4-4H6a4 4 0 00-4 4v2h5"></path>
                      <circle cx="9" cy="7" r="4"></circle>
                      <circle cx="17" cy="7" r="4"></circle>
                    </svg>
                    {{ bus.capacity }}
                  </div>
                </td>

                <td class="py-4">
                  {% if bus.route %}
                  <span
                    class="inline-flex items-center text-xs font-medium text-primary bg-primary/10 px-2.5 py-1 rounded-md border border-primary/20">
                    <svg class="w-3.5 h-3.5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M9 20l-5.447-2.724A2 2 0 013 15.382V6.618a2 2 0 011.553-1.894L9 2m0 18l6-3m-6 3V2m6 15l5.447-2.724A2 2 0 0021 12.382V6.618a2 2 0 00-1.553-1.894L15 2m0 15V2">
                      </path>
                    </svg>
                    {{ bus.route.route_str }}
                  </span>
                  {% else %}
                  <span
                    class="inline-flex items-center text-xs font-medium text-base-content/40 bg-base-200 px-2.5 py-1 rounded-md">
                    Unassigned
                  </span>
                  {% endif %}
                </td>

                <td class="text-center py-4">
                  <span
                    class="badge badge-sm badge-ghost text-success bg-success/10 border-0 font-semibold tracking-wide">
                    Active
                  </span>
                </td>

                <td class="text-right py-4 pr-6">
                  <a href="{% url 'edit_bus' bus.id %}"
                    class="btn btn-ghost btn-xs text-base-content/60 hover:text-primary hover:bg-primary/10 transition-colors opacity-0 group-hover:opacity-100">
                    Edit
                  </a>
                </td>
              </tr>
              {% empty %}
              <tr>
                <td colspan="6" class="py-16 text-center">
                  <div class="flex flex-col items-center justify-center">
                    <div class="w-16 h-16 bg-base-200 rounded-full flex items-center justify-center mb-4">
                      <svg class="w-8 h-8 text-base-content/30" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                          d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"></path>
                      </svg>
                    </div>
                    <p class="text-base-content/60 font-semibold text-lg">No vehicles found</p>
                    <p class="text-sm text-base-content/40 mt-1 max-w-sm">You haven't added any buses to the fleet yet.
                      Click the "Add Bus" button to get started.</p>
                  </div>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </form>

{% if page_obj.has_other_pages %}
<div class="flex items-center justify-between px-6 py-4 border-t border-base-200 bg-base-200/20">
  <span class="text-xs font-medium text-base-content/50">
    Showing page <span class="text-base-content font-bold">{{ page_obj.number }}</span> of {{ page_obj.paginator.num_pages }}
  </span>
  
  <div class="join">
    {% if page_obj.has_previous %}
      <a href="?page={{ page_obj.previous_page_number }}{% if search %}&search={{ search }}{% endif %}" class="join-item btn btn-xs btn-outline border-base-300 text-base-content/60 hover:bg-base-300">«</a>
    {% else %}
      <button class="join-item btn btn-xs btn-outline border-base-300 text-base-content/30 btn-disabled cursor-not-allowed">«</button>
    {% endif %}

    <button class="join-item btn btn-xs btn-active bg-primary text-primary-content border-primary">{{ page_obj.number }}</button>

    {% if page_obj.has_next %}
      <a href="?page={{ page_obj.next_page_number }}{% if search %}&search={{ search }}{% endif %}" class="join-item btn btn-xs btn-outline border-base-300 text-base-content/60 hover:bg-base-300">»</a>
    {% else %}
      <button class="join-item btn btn-xs btn-outline border-base-300 text-base-content/30 btn-disabled cursor-not-allowed">»</button>
    {% endif %}
  </div>
</div>
{% endif %}

    </div>
  </div>
</div>

<script>
  // Bulk Actions Logic
  const selectAllCheckbox = document.getElementById('selectAll');
  const rowCheckboxes = document.querySelectorAll('.rowCheck');
  const selectedCountText = document.getElementById('selectedCount');
  const bulkActionsBar = document.getElementById('bulk-actions');

  function updateBulkActions() {
    const count = document.querySelectorAll('.rowCheck:checked').length;
    selectedCountText.textContent = `${count} vehicle${count !== 1 ? 's' : ''} selected`;

    if (count > 0) {
      bulkActionsBar.classList.remove('hidden');
    } else {
      bulkActionsBar.classList.add('hidden');
    }
  }

  selectAllCheckbox?.addEventListener('change', () => {
    const isChecked = selectAllCheckbox.checked;
    rowCheckboxes.forEach(checkbox => checkbox.checked = isChecked);
    updateBulkActions();
  });

  rowCheckboxes.forEach(cb => cb.addEventListener('change', () => {
    const allChecked = Array.from(rowCheckboxes).every(checkbox => checkbox.checked);
    selectAllCheckbox.checked = allChecked;
    selectAllCheckbox.indeterminate = !allChecked && Array.from(rowCheckboxes).some(checkbox => checkbox.checked);
    updateBulkActions();
  }));
</script>
{% endblock main %}