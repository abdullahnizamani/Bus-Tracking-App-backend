{% extends "main.html" %}

{% block title %}Students{% endblock title %}



{% block main %}
<div class="space-y-6">

  <!-- Page Header -->
  <div class="flex items-center justify-between">
    <div>
      <h1 class="text-2xl font-semibold">Students</h1>
      <p class="text-sm opacity-60">Manage student accounts</p>
    </div>

    <a href="{% url 'add_students' %}"><button class="btn btn-primary">
      <i data-lucide="plus" class="w-4 h-4"></i>
      Add Student
    </button></a>
  </div>


  <form method="get" class="sticky top-4 z-20">
  <div class="flex flex-col md:flex-row md:items-center gap-3 p-4 bg-base-200 rounded-lg shadow-sm">

    <div class="relative w-full md:w-64">
      <input
        type="text"
        name="search"
        placeholder="Search name / ID"
        value="{{ request.GET.search }}"
        class="input input-sm input-bordered w-full pl-10"
      />
      <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400"></i>
    </div>

    <select name="bus" class="select select-sm select-bordered w-full md:w-52">
      <option value="">All Buses</option>
      {% for bus in buses %}
        <option value="{{ bus.id }}" {% if request.GET.bus == bus.id|stringformat:"s" %}selected{% endif %}>
          {{ bus.name }}
        </option>
      {% endfor %}
    </select>

    <select name="status" class="select select-sm select-bordered w-full md:w-40">
      <option value="">All Status</option>
      <option value="Active" {% if request.GET.status == "Active" %}selected{% endif %}>Active</option>
      <option value="Inactive" {% if request.GET.status == "Inactive" %}selected{% endif %}>Inactive</option>
    </select>

    <div class="md:ml-auto flex gap-2 items-center">
      <a href="{% url 'students' %}" class="btn btn-sm btn-error">Reset</a>
      <button type="submit" class="btn btn-sm btn-primary">Apply</button>
    </div>

  </div>
</form>
<!-- Bulk Actions Bar -->
<div id="bulkActions"
     class="hidden sticky top-20 z-30 bg-base-100 border border-base-200 rounded-lg p-3 shadow-sm flex flex-wrap items-center gap-3">

  <span class="text-sm font-medium">
    <span id="selectedCount">0</span> selected
  </span>

<label for="bulkDeleteModal" class="btn btn-sm btn-error" id="bulkDelete">
  <i data-lucide="trash-2" class="w-4 h-4"></i>
  Delete
</label>


  <div class="dropdown">
    <label tabindex="0" class="btn btn-sm btn-outline">
      <i data-lucide="bus" class="w-4 h-4"></i>
      Change Bus
    </label>
    <ul tabindex="0" class="dropdown-content menu p-2 shadow bg-base-100 rounded-box w-52">
      {% for bus in buses %}
      <li>
<a class="bulk-assign-bus" data-bus-id="{{ bus.id }}" data-bus-name="{{ bus.name }}">
  {{ bus.name }}
</a>
      </li>
      {% endfor %}
    </ul>
  </div>
<label for="bulkRemoveBusModal" class="btn btn-sm btn-warning" id="bulkRemoveBus">
  <i data-lucide="x-circle" class="w-4 h-4"></i>
  Remove Bus
</label>

</div>

  <!-- Students Table -->
  <div class="card bg-base-100 shadow-sm rounded-lg overflow-hidden">
<div class="overflow-x-auto md:overflow-x-visible">
      <table class="table table-zebra w-full">
        <thead class="bg-base-200 sticky top-0 z-10">
          <tr>
            <th><input type="checkbox" class="checkbox" id="selectAll" /></th>
            <th>Student</th>
            <th>Email</th>
            <th>Bus Assignment</th>
            <th>Phone</th>
            <th class="text-right">Actions</th>
          </tr>
        </thead>
        <tbody id="student-tbody">
          {% if students %}
          {% for student in students %}
          <tr data-id="{{ student.student_id }}">

            <th>
              <input type="checkbox" class="checkbox rowCheck" data-index="0" />
            </th>
            <td>
              <div class="flex items-center gap-3">
                <div class="avatar">
                  <div class="mask mask-squircle w-11">
                    <img src="{{ student.user.avatar.url}}" alt="Avatar" />
                  </div>
                </div>
                <div>
                  <div class="font-bold">{{ student.user.first_name }}</div>
                  <div class="text-sm opacity-50">{{ student.license_id }}</div>
                </div>
              </div>
            </td>
            <td class="text-sm">{{student.user.email}}</td>
            <td>
              {% if student.bus_id %}
              <span class="badge badge-info">{{ student.bus_id.name }}</span>
              {% else %}
              <span class="text-gray-400">Unassigned</span>
              {% endif %}

            </td>
            <td>{{ student.user.phone }}</td>
            <td class="text-right space-x-1">
            <a href="{% url 'edit_student' id=student.student_id %}" class="btn btn-square w-8 h-8 tooltip" data-tip="Edit">
    <i data-lucide="edit" class="w-4 h-4"></i>
</a>

              
<label class="btn btn-square w-8 h-8 tooltip delete-single" for="singleDeleteModal" data-student-id="{{ student.student_id }}" data-student-name="{{ student.user.first_name }}" data-tip="Delete">
  <i data-lucide="trash-2" class="w-4 h-4 text-error"></i>
</label>





              <label class="btn btn-square w-8 h-8 tooltip " for="passwordReset" data-tip="Reset Password" id="reset-password-btn"   data-student-id="{{ student.student_id }}">
                <i data-lucide="key-round" class="w-4 h-4"></i>
              </label>
              
            </td>
          </tr>
          {% endfor %}
          {% else %}
          <tr><td colspan="6" class="py-8 text-center text-sm opacity-60">
          No students match the current filters
        </td></tr>
          {% endif %}

        </tbody>
        <tfoot>
          <tr>
            <td colspan="100%">
              <div class="flex justify-between items-center p-4 border-t border-base-200 w-full">
                <div class="flex items-center gap-2">
                  <span class="text-sm text-base-content/70">Items per page</span>
                  <select class="select select-bordered select-sm" id="pageSize"
                    onchange="location = '?page_size=' + this.value">
                    <option value="10" {% if page_obj.paginator.per_page == 10 %}selected{% endif %}>10</option>
                    <option value="20" {% if page_obj.paginator.per_page == 20 %}selected{% endif %}>20</option>
                    <option value="50" {%if page_obj.paginator.per_page == 50 %}selected{% endif %}>50</option>
                  </select>
                </div>
                <div class="hidden sm:block text-sm text-base-content/70">
                  <span id="rangeText"></span>
                </div>
                <div class="join">
                  {% if page_obj.has_previous %}
                  <a href="?page={{ page_obj.previous_page_number }}" class="join-item btn btn-sm btn-outline">
                    Prev
                  </a>
                  {% else %}
                  <button class="join-item btn btn-sm btn-outline" disabled>
                    Prev
                  </button>
                  {% endif %}

                  <button class="join-item btn btn-sm btn-outline btn-active">
                    {{ page_obj.number }}
                  </button>

                  {% if page_obj.has_next %}
                  <a href="?page={{ page_obj.next_page_number }}" class="join-item btn btn-sm btn-outline">
                    Next
                  </a>
                  {% else %}
                  <button class="join-item btn btn-sm btn-outline" disabled>
                    Next
                  </button>
                  {% endif %}
                </div>
              </div>
            </td>
          </tr>
        </tfoot>
      </table>
    </div>
  </div>

</div>
<!-- Bulk Delete Confirmation Modal -->
<input type="checkbox" id="bulkDeleteModal" class="modal-toggle" />

<div class="modal">
  <div class="modal-box">
    <h3 class="font-bold text-lg text-error">
      Confirm Deletion
    </h3>

    <p class="py-3 text-sm opacity-80">
      You are about to delete <span class="font-semibold" id="deleteCount">0</span>
      student account(s).  
      <br>
      This action <span class="font-semibold">cannot be undone</span>.
    </p>

    <!-- POST FORM -->
    <form method="post" action="{% url 'bulk_delete_users' %}">
      {% csrf_token %}

      <!-- Will be populated via JS -->
      <input type="hidden" name="ids" id="deleteStudentIds" />
      <input type="hidden" name="role" value="student" />

      <div class="modal-action">
        <label for="bulkDeleteModal" class="btn btn-sm">
          Cancel
        </label>
        <button type="submit" class="btn btn-sm btn-error">
          Yes, Delete
        </button>
      </div>
    </form>
  </div>
</div>




<!-- Single Delete Confirmation Modal -->
<input type="checkbox" id="singleDeleteModal" class="modal-toggle" />

<div class="modal">
  <div class="modal-box">
    <h3 class="font-bold text-lg text-error">
      Confirm Deletion
    </h3>

    <p class="py-3 text-sm opacity-80">
      You are about to delete student <span class="font-semibold" id="singleDeleteStudentName"></span>.
      <br>
      This action <span class="font-semibold">cannot be undone</span>.
    </p>

    <!-- POST FORM -->
    <form method="post" action="{% url 'bulk_delete_users' %}">
      {% csrf_token %}

      <!-- Separate hidden input for single delete -->
      <input type="hidden" name="ids" id="singleDeleteStudentId" />
      <input type="hidden" name="role" value="student" />

      <div class="modal-action">
        <label for="singleDeleteModal" class="btn btn-sm">
          Cancel
        </label>
        <button type="submit" class="btn btn-sm btn-error">
          Yes, Delete
        </button>
      </div>
    </form>
  </div>
</div>



<!-- Bulk Assign Bus Modal -->
<input type="checkbox" id="bulkAssignBusModal" class="modal-toggle" />

<div class="modal">
  <div class="modal-box">
    <h3 class="font-bold text-lg">
      Assign Bus
    </h3>

    <p class="py-2 text-sm opacity-80">
      Assign selected students to the chosen bus.
    </p>

    <form method="post" action="{% url 'bulk_assign_bus' %}">
      {% csrf_token %}

      <input type="hidden" name="ids" id="assignBusStudentIds">
      <input type="hidden" name="bus_id" id="assignBusId">

      <div class="modal-action">
        <label for="bulkAssignBusModal" class="btn btn-sm">
          Cancel
        </label>
        <button type="submit" class="btn btn-sm btn-primary">
          Assign
        </button>
      </div>
    </form>
  </div>
</div>
<!-- Bulk Remove Bus Modal -->
<input type="checkbox" id="bulkRemoveBusModal" class="modal-toggle" />

<div class="modal">
  <div class="modal-box">
    <h3 class="font-bold text-lg text-warning">
      Remove Bus Assignment
    </h3>

    <p class="py-3 text-sm opacity-80">
      This will remove bus assignment from
      <span class="font-semibold" id="removeBusCount">0</span>
      student(s).
    </p>

    <form method="post" action="{% url 'bulk_remove_bus' %}">
      {% csrf_token %}
      <input type="hidden" name="ids" id="removeBusStudentIds">
      <input type="hidden" name="role" value="student" />

      <div class="modal-action">
        <label for="bulkRemoveBusModal" class="btn btn-sm">
          Cancel
        </label>
        <button type="submit" class="btn btn-sm btn-warning">
          Remove Bus
        </button>
      </div>
    </form>
  </div>
</div>





<!-- Password reset modal -->

<input type="checkbox" id="passwordReset" class="modal-toggle" />

<div class="modal">
  <div class="modal-box">
    <h3 class="font-bold text-lg text-info">
      Password reset
    </h3>

    <p class="py-3 text-sm opacity-80">
Are you sure you want to reset the password for this user?
      <br>
      This action <span class="font-semibold">cannot be undone</span>.
    </p>

    <!-- POST FORM -->
    <form method="post" action="{% url 'password_reset' %}">
      {% csrf_token %}

      <input type="hidden" name="ids" id="passwordResetId" />
      <input type="hidden" name="role" value="student" />

      <div class="modal-action">
        <label for="passwordReset" class="btn btn-sm">
          Cancel
        </label>
        <button type="submit" class="btn btn-sm btn-success">
          Yes, Reset
        </button>
      </div>
    </form>
  </div>
</div>
<script>
  const selectAll = document.getElementById('selectAll');
  const rowChecks = document.querySelectorAll('.rowCheck');
  const bulkBar = document.getElementById('bulkActions');
  const selectedCountEl = document.getElementById('selectedCount');

  const deleteIdsInput = document.getElementById('deleteStudentIds');
  const deleteCountText = document.getElementById('deleteCount');

  function getSelectedIds() {
    return [...document.querySelectorAll('.rowCheck:checked')]
      .map(cb => cb.closest('tr').dataset.id);
  }

  function updateBulkUI() {
    const selectedIds = getSelectedIds();
    selectedCountEl.textContent = selectedIds.length;

    if (selectedIds.length > 0) {
      bulkBar.classList.remove('hidden');
    } else {
      bulkBar.classList.add('hidden');
    }

    selectAll.checked = selectedIds.length === rowChecks.length && rowChecks.length > 0;
  }

  // Select all
  selectAll.addEventListener('change', () => {
    rowChecks.forEach(cb => cb.checked = selectAll.checked);
    updateBulkUI();
  });

  // Individual rows
  rowChecks.forEach(cb => {
    cb.addEventListener('change', updateBulkUI);
  });

  // Populate delete modal
  document.getElementById('bulkDelete').addEventListener('click', () => {
    const ids = getSelectedIds();
    deleteIdsInput.value = ids.join(',');
    deleteCountText.textContent = ids.length;
  });

    function getSelectedStudentIds() {
    return [...document.querySelectorAll('.rowCheck:checked')]
      .map(cb => cb.closest('tr').dataset.id);
  }

  // Assign bus
  document.querySelectorAll('.bulk-assign-bus').forEach(item => {
    item.addEventListener('click', () => {
      const ids = getSelectedStudentIds();
      document.getElementById('assignBusStudentIds').value = ids.join(',');
      document.getElementById('assignBusId').value = item.dataset.busId;
      document.getElementById('bulkAssignBusModal').checked = true;
    });
  });

  // Remove bus
  document.getElementById('bulkRemoveBus').addEventListener('click', () => {
    const ids = getSelectedStudentIds();
    document.getElementById('removeBusStudentIds').value = ids.join(',');
    document.getElementById('removeBusCount').textContent = ids.length;
  });

document.querySelectorAll('#reset-password-btn').forEach(lbl => {
  lbl.addEventListener('click', () => {
    const studentId = lbl.dataset.studentId;

    document.getElementById('passwordResetId').value = studentId;
  });
});



// Single Delete
document.querySelectorAll('.delete-single').forEach(btn => {
  btn.addEventListener('click', () => {
    const studentId = btn.dataset.studentId;
    const studentName = btn.dataset.studentName;

    document.getElementById('singleDeleteStudentId').value = studentId;
    document.getElementById('singleDeleteStudentName').textContent = studentName;
  });
});


</script>


{% endblock main %}