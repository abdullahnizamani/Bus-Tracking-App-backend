{% extends 'main.html' %}

{% block navbar %} 
{% endblock navbar %}

{% block title %}Add Bus{% endblock title %}

{% block head %}
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css" />
  <style>
    .form-container {
      background-color: #ffffff;
      border-radius: 8px;
      padding: 3rem;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .form-container h1 {
      font-size: 1.75rem;
      color: #333;
      font-weight: 600;
    }

    .form-container p {
      color: #555;
      margin-bottom: 1.5rem;
    }

    .input, .btn {
      border-radius: 8px;
    }

    .input {
      padding: 0.75rem;
      border: 2px solid #e0e0e0;
      width: 100%;
      transition: all 0.3s ease;
    }

    .input:focus {
      border-color: #4caf50;
      outline: none;
    }

    .btn {
      padding: 0.75rem 1.5rem;
      font-size: 1rem;
      transition: background-color 0.3s ease, transform 0.3s ease;
    }

    .btn-outline {
      border: 2px solid #4caf50;
      color: #4caf50;
      background-color: transparent;
    }

    .btn-primary {
      background-color: #4caf50;
      color: #fff;
      border: 2px solid #4caf50;
    }

    .btn:hover {
      transform: scale(1.05);
    }

    .btn-outline:hover {
      background-color: #4caf50;
      color: white;
    }

    .btn-primary:hover {
      background-color: #45a049;
    }

    #map {
      border-radius: 8px;
      margin-top: 1rem;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
    }

    .form-group {
      margin-bottom: 1.5rem;
    }

    .form-group label {
      font-weight: 600;
      color: #333;
      display: block;
      margin-bottom: 0.5rem;
    }

    .form-group input, .form-group select {
      padding: 0.75rem;
      font-size: 1rem;
      border-radius: 8px;
      width: 100%;
      border: 2px solid #e0e0e0;
    }

    .form-group input:focus, .form-group select:focus {
      border-color: #4caf50;
      outline: none;
    }
  </style>
{% endblock head %}

{% block main %}
<main class="p-6 flex justify-center items-center bg-base-100 min-h-screen">
  <!-- Form container -->
  <div class="form-container w-full max-w-lg">

    <!-- Header -->
    <h1 class="text-center mb-4">Add New Bus</h1>
    <p class="text-center text-sm text-gray-500">Fill out the details to add a new bus to the system.</p>

    <!-- Form -->
    <form method="POST" class="space-y-6" id="bus-form">
      {% csrf_token %}

      <!-- Bus Name -->
      <div class="form-group">
        <label for="name">Bus Name</label>
        {{ form.name }}
      </div>

      <!-- Registration Number -->
      <div class="form-group">
        <label for="registration_number">Registration Number</label>
        {{ form.registration_number }}
      </div>

      <!-- Route Path -->
      <div class="form-group">
        <label for="route_str">Route Path</label>
        <input type="text" name="route_str" id="route_str" placeholder="Enter Path alphabetically" class="input input-bordered w-full" required />
      </div>

      <!-- Driver -->
      <div class="form-group">
        <label for="driver_id">Driver</label>
        {{ form.driver_id }}
      </div>

      <!-- Capacity -->
      <div class="form-group">
        <label for="capacity">Capacity</label>
        {{ form.capacity }}
      </div>

      <!-- Map -->
      <div id="map" class="w-full h-80"></div>

      <!-- Buttons -->
      <div class="flex justify-between mt-6">
        <a href="{% url 'buses' %}" class="btn btn-outline">Cancel</a>
        <button type="submit" class="btn btn-primary">Add Bus</button>
      </div>

    </form>

  </div>
</main>

<script>
  // Initialize the map
  const map = L.map('map').setView([24.946631, 67.079285], 9);  

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
  }).addTo(map);

  const drawnItems = new L.FeatureGroup();
  map.addLayer(drawnItems);

  const drawControl = new L.Control.Draw({
    edit: {
      featureGroup: drawnItems
    },
    draw: {
      polyline: true, 
      polygon: false, 
      circle: false,
      marker: false,
      rectangle: false,
    }
  });
  map.addControl(drawControl);

  map.on(L.Draw.Event.CREATED, function(e) {
    const layer = e.layer;
    drawnItems.addLayer(layer);
  });

  document.getElementById('bus-form').addEventListener('submit', function(e) {
    e.preventDefault(); 

    const layers = drawnItems.getLayers();
    if (layers.length === 0) {
      alert("Please draw a route before submitting!");
      return;
    }

    const routeCoordinates = layers[0].getLatLngs().map(latlng => [latlng.lng, latlng.lat]);

    let coordsInput = document.createElement('input');
    coordsInput.type = 'hidden';
    coordsInput.name = 'coordinates'; 
    coordsInput.value = JSON.stringify(routeCoordinates);

    this.appendChild(coordsInput);

    // Submit the form
    this.submit();
  });
</script>

{% endblock main %}
