{% extends "main.html" %}

{% block title %}Drivers{% endblock title %}



{% block main %}
<div class="space-y-6">

  <!-- Page Header -->
  <div class="flex items-center justify-between">
    <div>
      <h1 class="text-2xl font-semibold">Drivers</h1>
      <p class="text-sm opacity-60">Manage Driver accounts</p>
    </div>

    <a href="{% url 'add_drivers' %}"><button class="btn btn-primary">
        <i data-lucide="plus" class="w-4 h-4"></i>
        Add Driver
      </button></a>
  </div>

<form method="get" class="sticky top-4 z-20">
  <div class="flex flex-col md:flex-row md:items-center gap-3 p-4 bg-base-200 rounded-lg shadow-sm">

    <div class="relative w-full md:w-64">
      <input
        type="text"
        name="search"
        placeholder="Search name / ID"
        value="{{ request.GET.search }}"
        class="input input-sm input-bordered w-full pl-10"
      />
      <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400"></i>
    </div>

    <select name="bus" class="select select-sm select-bordered w-full md:w-52">
      <option value="">All Buses</option>
      {% for bus in buses %}
        <option value="{{ bus.id }}" {% if request.GET.bus == bus.id|stringformat:"s" %}selected{% endif %}>
          {{ bus.name }}
        </option>
      {% endfor %}
    </select>

    <select name="status" class="select select-sm select-bordered w-full md:w-40">
      <option value="">All Status</option>
      <option value="Active" {% if request.GET.status == "Active" %}selected{% endif %}>Active</option>
      <option value="Inactive" {% if request.GET.status == "Inactive" %}selected{% endif %}>Inactive</option>
    </select>

    <div class="md:ml-auto flex gap-2 items-center">
      <a href="{% url 'drivers' %}" class="btn btn-sm btn-error">Reset</a>
      <button type="submit" class="btn btn-sm btn-primary">Apply</button>
    </div>

  </div>
</form>
<div id="bulkActions"
     class="hidden sticky top-20 z-30 bg-base-100 border border-base-200 rounded-lg p-3 shadow-sm flex flex-wrap items-center gap-3">

  <span class="text-sm font-medium">
    <span id="selectedCount">0</span> selected
  </span>

<label for="bulkDeleteModal" class="btn btn-sm btn-error" id="bulkDelete">
  <i data-lucide="trash-2" class="w-4 h-4"></i>
  Delete
</label>



<label for="bulkRemoveBusModal" class="btn btn-sm btn-warning" id="bulkRemoveBus">
  <i data-lucide="x-circle" class="w-4 h-4"></i>
  Remove Bus
</label>
</div>

  <!-- Drivers Table -->
  <div class="card bg-base-100 shadow-sm rounded-lg overflow-hidden">
    <div class="overflow-x-auto md:overflow-x-visible">
      <table class="table table-zebra w-full">
        <thead class="bg-base-200 sticky top-0 z-10">
          <tr>
            <th><input type="checkbox" class="checkbox" id="selectAll" /></th>
            <th>Driver</th>
            <th>License ID</th>
            <th>Email</th>
            <th>Bus Assignment</th>
            <th>Phone</th>
            <th class="text-right">Actions</th>
          </tr>
        </thead>
        <tbody id="Drivers-tbody">
          {% if drivers %}
          {% for driver in drivers %}
          <tr data-id="{{ driver.employee_id }}">
            <th>
              <input type="checkbox" class="checkbox rowCheck" data-index="0" />
            </th>
            <td>
              <div class="flex items-center gap-3">
                <div class="avatar">
                  <div class="mask mask-squircle w-11">
                    <img src="{{ driver.user.avatar.url}}" alt="Avatar" />
                  </div>
                </div>
                <div>
                  <div class="font-bold">{{ driver.user.first_name }}</div>
                  <div class="text-sm opacity-50">{{ driver.employee_id }}</div>
                </div>
              </div>
            </td>
            <td>{{driver.license_id}}</td>

            <td class="text-sm">{{driver.user.email}}</td>
            <td>
              {% if driver.bus %}
              <span class="badge badge-info">{{ driver.bus.name}}</span>
              {% else %}
              <span class="text-driver_id-400">Unassigned</span>
              {% endif %}

            </td>
            <td>{{ driver.user.phone }}</td>
            <td class="text-right space-x-1">
<!-- <a class="btn btn-square w-8 h-8 tooltip view-driver" data-tip="View" 
       data-driver-id="{{ driver.employee_id }}" href="">
    <i data-lucide="eye" class="w-4 h-4"></i>
            </a> -->
            <a href="{% url 'edit_driver' id=driver.employee_id %}" class="btn btn-square w-8 h-8 tooltip" data-tip="Edit">
    <i data-lucide="edit" class="w-4 h-4"></i>
</a>


        <label class="btn btn-square w-8 h-8 tooltip delete-single" for="singleDeleteModal"
          data-driver-id="{{ driver.employee_id }}" data-driver-name="{{ driver.user.first_name }}" data-tip="Delete">
          <i data-lucide="trash-2" class="w-4 h-4 text-error"></i>
        </label>

        <label class="btn btn-square w-8 h-8 tooltip " for="passwordReset" data-tip="Reset Password" id="reset-password-btn"
          data-driver-id="{{ driver.employee_id }}">
          <i data-lucide="key-round" class="w-4 h-4"></i>
        </label>
            </td>
          </tr>
          {% endfor %}
          {% else %}
          <tr><td colspan="6" class="py-8 text-center text-sm opacity-60">
          No drivers match the current filters
        </td></tr>
          {% endif %}

        </tbody>
        <tfoot>
          <tr>
            <td colspan="100%">
              <div class="flex justify-between items-center p-4 border-t border-base-200 w-full">
                <div class="flex items-center gap-2">
                  <span class="text-sm text-base-content/70">Items per page</span>
                  <select class="select select-bordered select-sm" id="pageSize"
                    onchange="location = '?page_size=' + this.value">
                    <option value="10" {% if page_obj.paginator.per_page == 10 %}selected{% endif %}>10</option>
                    <option value="20" {% if page_obj.paginator.per_page == 20 %}selected{% endif %}>20</option>
                    <option value="50" {%if page_obj.paginator.per_page == 50 %}selected{% endif %}>50</option>
                  </select>
                </div>
                <div class="hidden sm:block text-sm text-base-content/70">
                  <span id="rangeText"></span>
                </div>
                <div class="join">
                  {% if page_obj.has_previous %}
                  <a href="?page={{ page_obj.previous_page_number }}" class="join-item btn btn-sm btn-outline">
                    Prev
                  </a>
                  {% else %}
                  <button class="join-item btn btn-sm btn-outline" disabled>
                    Prev
                  </button>
                  {% endif %}

                  <button class="join-item btn btn-sm btn-outline btn-active">
                    {{ page_obj.number }}
                  </button>

                  {% if page_obj.has_next %}
                  <a href="?page={{ page_obj.next_page_number }}" class="join-item btn btn-sm btn-outline">
                    Next
                  </a>
                  {% else %}
                  <button class="join-item btn btn-sm btn-outline" disabled>
                    Next
                  </button>
                  {% endif %}
                </div>

              </div>
            </td>
          </tr>
        </tfoot>
      </table>
    </div>
  </div>

</div>


<!-- Bulk Delete Confirmation Modal -->
<input type="checkbox" id="bulkDeleteModal" class="modal-toggle" />

<div class="modal">
  <div class="modal-box">
    <h3 class="font-bold text-lg text-error">
      Confirm Deletion
    </h3>

    <p class="py-3 text-sm opacity-80">
      You are about to delete <span class="font-semibold" id="deleteCount">0</span>
      driver account(s).  
      <br>
      This action <span class="font-semibold">cannot be undone</span>.
    </p>

    <!-- POST FORM -->
    <form method="post" action="{% url 'bulk_delete_users' %}">
      {% csrf_token %}

      <!-- Will be populated via JS -->
      <input type="hidden" name="ids" id="deletedriverIds" />
      <input type="hidden" name="role" value="driver" />

      <div class="modal-action">
        <label for="bulkDeleteModal" class="btn btn-sm">
          Cancel
        </label>
        <button type="submit" class="btn btn-sm btn-error">
          Yes, Delete
        </button>
      </div>
    </form>
  </div>
</div>




<!-- Bulk Remove Bus Modal -->
<input type="checkbox" id="bulkRemoveBusModal" class="modal-toggle" />

<div class="modal">
  <div class="modal-box">
    <h3 class="font-bold text-lg text-warning">
      Remove Bus Assignment
    </h3>

    <p class="py-3 text-sm opacity-80">
      This will remove bus assignment from
      <span class="font-semibold" id="removeBusCount">0</span>
      driver(s).
    </p>

    <form method="post" action="{% url 'bulk_remove_bus' %}">
      {% csrf_token %}
      <input type="hidden" name="ids" id="removeBusdriverIds">
      <input type="hidden" name="role" value="driver" />

      <div class="modal-action">
        <label for="bulkRemoveBusModal" class="btn btn-sm">
          Cancel
        </label>
        <button type="submit" class="btn btn-sm btn-warning">
          Remove Bus
        </button>
      </div>
    </form>
  </div>
</div>



<!-- Password reset modal -->

<input type="checkbox" id="passwordReset" class="modal-toggle" />

<div class="modal">
  <div class="modal-box">
    <h3 class="font-bold text-lg text-info">
      Password reset
    </h3>

    <p class="py-3 text-sm opacity-80">
Are you sure you want to reset the password for this user?
      <br>
      This action <span class="font-semibold">cannot be undone</span>.
    </p>

    <!-- POST FORM -->
    <form method="post" action="{% url 'password_reset' %}">
      {% csrf_token %}

      <input type="hidden" name="ids" id="passwordResetId" />
      <input type="hidden" name="role" value="driver" />

      <div class="modal-action">
        <label for="passwordReset" class="btn btn-sm">
          Cancel
        </label>
        <button type="submit" class="btn btn-sm btn-success">
          Yes, Reset
        </button>
      </div>
    </form>
  </div>
</div>



<!-- Single Delete Confirmation Modal -->
<input type="checkbox" id="singleDeleteModal" class="modal-toggle" />

<div class="modal">
  <div class="modal-box">
    <h3 class="font-bold text-lg text-error">
      Confirm Deletion
    </h3>

    <p class="py-3 text-sm opacity-80">
      You are about to delete driver <span class="font-semibold" id="singleDeleteDriverName"></span>.
      <br>
      This action <span class="font-semibold">cannot be undone</span>.
    </p>

    <!-- POST FORM -->
    <form method="post" action="{% url 'bulk_delete_users' %}">
      {% csrf_token %}

      <!-- Separate hidden input for single delete -->
      <input type="hidden" name="ids" id="singleDeleteDriverId" />
      <input type="hidden" name="role" value="driver" />

      <div class="modal-action">
        <label for="singleDeleteModal" class="btn btn-sm">
          Cancel
        </label>
        <button type="submit" class="btn btn-sm btn-error">
          Yes, Delete
        </button>
      </div>
    </form>
  </div>
</div>





<script>
  const selectAll = document.getElementById('selectAll');
  const rowChecks = document.querySelectorAll('.rowCheck');
  const bulkBar = document.getElementById('bulkActions');
  const selectedCountEl = document.getElementById('selectedCount');

  const deleteIdsInput = document.getElementById('deletedriverIds');
  const deleteCountText = document.getElementById('deleteCount');

  function getSelectedIds() {
    return [...document.querySelectorAll('.rowCheck:checked')]
      .map(cb => cb.closest('tr').dataset.id);
  }

  function updateBulkUI() {
    const selectedIds = getSelectedIds();
    selectedCountEl.textContent = selectedIds.length;

    if (selectedIds.length > 0) {
      bulkBar.classList.remove('hidden');
    } else {
      bulkBar.classList.add('hidden');
    }

    selectAll.checked = selectedIds.length === rowChecks.length && rowChecks.length > 0;
  }

  // Select all
  selectAll.addEventListener('change', () => {
    rowChecks.forEach(cb => cb.checked = selectAll.checked);
    updateBulkUI();
  });

  // Individual rows
  rowChecks.forEach(cb => {
    cb.addEventListener('change', updateBulkUI);
  });

  // Populate delete modal
  document.getElementById('bulkDelete').addEventListener('click', () => {
    const ids = getSelectedIds();
    deleteIdsInput.value = ids.join(',');
    deleteCountText.textContent = ids.length;
  });

    document.getElementById('bulkRemoveBus').addEventListener('click', () => {
    const ids = getSelectedIds();
    document.getElementById('removeBusdriverIds').value = ids.join(',');
    document.getElementById('removeBusCount').textContent = ids.length;
  });



document.querySelectorAll('#reset-password-btn').forEach(lbl => {
  lbl.addEventListener('click', () => {
    const driverId = lbl.dataset.driverId;

    document.getElementById('passwordResetId').value = driverId;
  });
});












// Single Delete
document.querySelectorAll('.delete-single').forEach(btn => {
  btn.addEventListener('click', () => {
    const driverId = btn.dataset.driverId;
    const driverName = btn.dataset.driverName;
    document.getElementById('singleDeleteDriverId').value = driverId;
    document.getElementById('singleDeleteDriverName').textContent = driverName;
  });
});

</script>

{% endblock main %}