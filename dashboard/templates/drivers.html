{% extends "main.html" %}

{% block title %}Students{% endblock title %}



{% block main %}
<div class="space-y-6">

  <!-- Page Header -->
  <div class="flex items-center justify-between">
    <div>
      <h1 class="text-2xl font-semibold">Students</h1>
      <p class="text-sm opacity-60">Manage student accounts</p>
    </div>

    <a href="{% url 'add_students' %}"><button class="btn btn-primary">
      <i data-lucide="plus" class="w-4 h-4"></i>
      Add Student
    </button></a>
  </div>

  <!-- Filters Toolbar (Sticky) -->
  <div class="sticky top-4 z-20">
    <div class="flex flex-col md:flex-row md:items-center gap-3 p-4 bg-base-200 rounded-lg shadow-sm">

      <div class="relative w-full md:w-64">
        <input type="text" placeholder="Search name / ID" class="input input-sm input-bordered w-full pl-10" id="searchInput" />
        <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400"></i>
      </div>

      <select class="select select-sm select-bordered w-full md:w-52" id="busSelect">
        <option value="">All Buses</option>
      </select>

      <select id="statusSelect" class="select select-sm select-bordered w-full md:w-40">
        <option value="">All Status</option>
        <option value="Active">Active</option>
        <option value="Inactive">Inactive</option>
      </select>

      <div class="md:ml-auto flex gap-2 items-center">
        <span id="selectedCount" class="text-sm opacity-60">0 selected</span>
        <button class="btn btn-xs btn-outline btn-error" disabled>Delete Selected</button>
        <button id="reset" type="reset" class="btn btn-sm btn-error">Reset</button>
        <button class="btn btn-sm btn-outline btn-primary">Apply</button>
      </div>

    </div>
  </div>

  <!-- Students Table -->
  <div class="card bg-base-100 shadow-sm rounded-lg overflow-hidden">
<div class="overflow-x-auto md:overflow-x-visible">
      <table class="table table-zebra w-full">
        <thead class="bg-base-200 sticky top-0 z-10">
          <tr>
            <th><input type="checkbox" class="checkbox" id="selectAll" /></th>
            <th>Student</th>
            <th>Email</th>
            <th>Bus Assignment</th>
            <th>Phone</th>
            <th class="text-right">Actions</th>
          </tr>
        </thead>
        <tbody id="students-tbody">
{% if drivers %}
{% for driver in drivers %}
<tr>
  <th>
    <input type="checkbox" class="checkbox rowCheck" data-index="0" />
  </th>
  <td>
    <div class="flex items-center gap-3">
      <div class="avatar">
        <div class="mask mask-squircle w-11">
          <img src="{{ driver.user.avatar.url}}" alt="Avatar" />
        </div>
      </div>
      <div>
        <div class="font-bold">{{ driver.user.first_name }}</div>
        <div class="text-sm opacity-50">{{ driver.license_id }}</div>
      </div>
    </div>
  </td>
  <td class="text-sm">{{driver.user.email}}</td>
  <td>
    {% if driver.bus_id %}
    <span class="badge badge-info">{{ driver.bus_id}}</span>
    {% else %}
    <span class="text-gray-400">Unassigned</span>
    {% endif %}
  </td>
  <td>+1 234 567 890</td>
  <td class="text-right space-x-1">
    <button class="btn btn-square w-8 h-8 tooltip" data-tip="View">
      <i data-lucide="eye" class="w-4 h-4"></i>
    </button>
    <button class="btn btn-square w-8 h-8 tooltip delete-single" data-index="0" data-tip="Delete">
      <i data-lucide="trash-2" class="w-4 h-4 text-error"></i>
    </button>
    <button class="btn btn-square w-8 h-8 tooltip" data-tip="Reset Password">
      <i data-lucide="key-round" class="w-4 h-4"></i>
    </button>
  </td>
</tr>
{% endfor %}

{% endif %}

        </tbody>
        <tfoot>
          <tr>
            <td colspan="100%">
              <div class="flex justify-between items-center p-4 border-t border-base-200 w-full">
                <div class="flex items-center gap-2">
                  <span class="text-sm text-base-content/70">Items per page</span>
                  <select class="select select-bordered select-sm" id="pageSize">
                    <option selected>10</option>
                    <option>20</option>
                    <option>50</option>
                  </select>
                </div>
                <div class="hidden sm:block text-sm text-base-content/70">
                  <span id="rangeText"></span>
                </div>
                <div class="join">
                  <button class="join-item btn btn-sm btn-outline" id="prevPage">Prev</button>
                  <button class="join-item btn btn-sm btn-outline btn-active">1</button>
                  <button class="join-item btn btn-sm btn-outline" id="nextPage">Next</button>
                </div>
              </div>
            </td>
          </tr>
        </tfoot>
      </table>
    </div>
  </div>

</div>
<!-- 
<script>
document.addEventListener("DOMContentLoaded", () => {
  const API_URL = "{% url 'users' 'student' %}";

  const tbody = document.getElementById("students-tbody");
  const pageSizeSelect = document.getElementById("pageSize");
  const rangeText = document.getElementById("rangeText");
  const busSelect = document.getElementById("busSelect");
  const searchInput = document.getElementById("searchInput");
  const statusSelect = document.getElementById("statusSelect");
  const resetBtn = document.getElementById("reset");
  const selectAll = document.getElementById("selectAll");
  const selectedCount = document.getElementById("selectedCount");
  const deleteBtn = document.querySelector(".btn-outline.btn-error");
  
  // Add Change Bus button
  const changeBusBtn = document.createElement("button");
  changeBusBtn.id = "changeBus";
  changeBusBtn.textContent = "Change Bus";
  changeBusBtn.className = "btn btn-xs btn-outline btn-primary";
  changeBusBtn.disabled = true;
  document.querySelector(".md\\:ml-auto").insertBefore(changeBusBtn, deleteBtn);

  let students = [];
  let filteredStudents = [];
  let busMap = {};
  let currentPage = 1;
  let pageSize = parseInt(pageSizeSelect.value);

  // Loading skeleton
  tbody.innerHTML = `
    <tr><td colspan="6" class="p-6 text-center">
      <span class="loading loading-dots loading-md"></span>
    </td></tr>`;

  async function fetchStudents() {
    const res = await fetch(API_URL);
    students = await res.json();
    filteredStudents = [...students];
    renderTable();
  }

  async function busPopulate() {
    const res = await fetch("{% url 'buses_list' %}");
    const buses = await res.json();
    buses.forEach(bus => {
      busMap[bus.id] = bus.name;
      const option = document.createElement("option");
      option.value = bus.id;
      option.textContent = bus.name;
      busSelect.appendChild(option);
    });
  }

  function applyFilters() {
    const term = searchInput.value.toLowerCase();
    const bus = busSelect.value;
    const status = statusSelect.value;

    filteredStudents = students.filter(s => {
      const name = `${s.first_name} ${s.last_name}`.toLowerCase();
      const sid = s.student?.student_id?.toLowerCase() || "";

      return (
        (name.includes(term) || sid.includes(term)) &&
        (!bus || s.student?.bus_id == bus) &&
        (!status || (status === "Active" ? s.is_active : !s.is_active))
      );
    });

    currentPage = 1;
    renderTable();
  }

  function renderTable() {
    tbody.innerHTML = "";

    const start = (currentPage - 1) * pageSize;
    const end = start + pageSize;
    const pageItems = filteredStudents.slice(start, end);

    if (pageItems.length === 0) {
      tbody.innerHTML = `
        <tr><td colspan="6" class="py-8 text-center text-sm opacity-60">
          No students match the current filters
        </td></tr>`;
      updateFooter();
      renderPagination();
      return;
    }

    pageItems.forEach((s, index) => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <th><input type="checkbox" class="checkbox rowCheck" data-index="${start + index}" /></th>
        <td>
          <div class="flex items-center gap-3">
            <div class="avatar">
              <div class="mask mask-squircle w-11">
                <img src="${s.avatar || '/static/img/avatar-placeholder.png'}" />
              </div>
            </div>
            <div>
              <div class="font-bold">${s.first_name} ${s.last_name}</div>
              <div class="text-sm opacity-50">${s.student?.student_id ?? "—"}</div>
            </div>
          </div>
        </td>
        <td class="text-sm">${s.email ?? "—"}</td>
        <td>${s.student?.bus_id ? `<span class='badge badge-info'>${busMap[s.student.bus_id] ?? 'Unknown'}</span>` : `<span class='text-gray-400'>Unassigned</span>`}</td>
        <td>${s.phone ?? "—"}</td>
        <td class="text-right space-x-1">
          <button class="btn btn-square w-8 h-8 tooltip" data-tip="View"><i data-lucide="eye" class="w-4 h-4"></i></button>
          <button class="btn btn-square w-8 h-8 tooltip delete-single" data-index="${start + index}" data-tip="Delete"><i data-lucide="trash-2" class="w-4 h-4 text-error"></i></button>
          <button class="btn btn-square w-8 h-8 tooltip " data-tip="Reset Password"><i data-lucide="key-round" class="w-4 h-4"></i></button>
        </td>`;
      tbody.appendChild(tr);
    });

    lucide.createIcons();
    updateFooter();
    renderPagination();
  }

  function updateFooter() {
    const total = filteredStudents.length;
    const start = Math.min((currentPage - 1) * pageSize + 1, total);
    const end = Math.min(currentPage * pageSize, total);
    rangeText.textContent = `Showing ${start}-${end} out of ${total}`;
  }

  function renderPagination() {
    const totalPages = Math.ceil(filteredStudents.length / pageSize);
    const container = document.querySelector(".join");
    container.innerHTML = "";

    const prevBtn = document.createElement("button");
    prevBtn.textContent = "Prev";
    prevBtn.className = "join-item btn btn-sm btn-outline";
    prevBtn.disabled = currentPage === 1;
    prevBtn.addEventListener("click", () => { currentPage--; renderTable(); });
    container.appendChild(prevBtn);

    for (let i = 1; i <= totalPages; i++) {
      const btn = document.createElement("button");
      btn.textContent = i;
      btn.className = `join-item btn btn-sm btn-outline ${i === currentPage ? 'btn-active' : ''}`;
      btn.addEventListener("click", () => { currentPage = i; renderTable(); });
      container.appendChild(btn);
    }

    const nextBtn = document.createElement("button");
    nextBtn.textContent = "Next";
    nextBtn.className = "join-item btn btn-sm btn-outline";
    nextBtn.disabled = currentPage === totalPages;
    nextBtn.addEventListener("click", () => { currentPage++; renderTable(); });
    container.appendChild(nextBtn);
  }

  function updateSelectedCount() {
    const count = document.querySelectorAll(".rowCheck:checked").length;
    selectedCount.textContent = `${count} selected`;
    deleteBtn.disabled = count === 0;
    changeBusBtn.disabled = count === 0;
  }

  selectAll.addEventListener("change", () => {
    document.querySelectorAll(".rowCheck").forEach(cb => cb.checked = selectAll.checked);
    updateSelectedCount();
  });

  tbody.addEventListener("change", e => {
    if (e.target.classList.contains("rowCheck")) {
      const allChecked = document.querySelectorAll(".rowCheck:checked").length === document.querySelectorAll(".rowCheck").length;
      selectAll.checked = allChecked;
      updateSelectedCount();
    }
  });

  deleteBtn.addEventListener("click", () => {
    const selectedIds = Array.from(document.querySelectorAll(".rowCheck:checked"))
      .map(cb => filteredStudents[cb.dataset.index].id);
    if (!selectedIds.length) return;

    if (confirm(`Delete ${selectedIds.length} students?`)) {
      fetch("{% url 'students' %}", {
        method: "POST",
        headers: { "Content-Type": "application/json", "X-CSRFToken": "{{ csrf_token }}" },
        body: JSON.stringify({ student_ids: selectedIds })
      }).then(() => fetchStudents());
    }
  });

  changeBusBtn.addEventListener("click", () => {
    const selectedIds = Array.from(document.querySelectorAll(".rowCheck:checked"))
      .map(cb => filteredStudents[cb.dataset.index].id);
    const newBus = prompt("Enter new Bus ID for selected students:");
    if (!newBus) return;

    fetch("{% url 'buses' %}", {
      method: "POST",
      headers: { "Content-Type": "application/json", "X-CSRFToken": "{{ csrf_token }}" },
      body: JSON.stringify({ student_ids: selectedIds, bus_id: newBus })
    }).then(() => fetchStudents());
  });

  pageSizeSelect.addEventListener("change", () => {
    pageSize = parseInt(pageSizeSelect.value);
    currentPage = 1;
    renderTable();
  });

  [searchInput, busSelect, statusSelect].forEach(el => el.addEventListener("input", applyFilters));

  resetBtn.addEventListener("click", () => {
    searchInput.value = "";
    busSelect.value = "";
    statusSelect.value = "";
    filteredStudents = [...students];
    currentPage = 1;
    selectAll.checked = false;
    updateSelectedCount();
    renderTable();
  });

  // Fetch data
  fetchStudents();
  busPopulate();
});
</script> -->

{% endblock main %}